# --- QUY TR√åNH T·ª∞ ƒê·ªòNG H√ìA CU·ªêI C√ôNG - PHI√äN B·∫¢N "B·∫¶Y S√ìI B·ªÄN B·ªà" ---
# C·∫≠p nh·∫≠t: Tri·ªÉn khai m·ªôt ƒë·ªôi ng≈© song song, m·ªói th√†nh vi√™n c√≥ kh·∫£ nƒÉng t·ª± l√†m m·ªõi proxy.

name: 'TopCV Daily Scraper'

on:
  schedule:
    - cron: '0 0 * * *' # N·ª≠a ƒë√™m gi·ªù UTC (7h s√°ng gi·ªù VN)
  workflow_dispatch:

jobs:
  # --- GIAI ƒêO·∫†N 1: "TH√ÅM T·ª¨ D√ÄY D·∫†N" (T·ª± ch·ªß) ---
  discover:
    runs-on: ubuntu-latest
    outputs:
      totalPages: ${{ steps.get_pages.outputs.count }}
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4
      - name: 'Set up Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: 'Setup Chrome browser for Scout'
        uses: browser-actions/setup-chrome@latest
      - name: 'Install dependencies for scout'
        run: npm install puppeteer puppeteer-extra puppeteer-extra-plugin-stealth cheerio
      - name: 'Run scout script to get total pages'
        id: get_pages
        # "Th√°m t·ª≠" kh√¥ng c·∫ßn proxy, v√¨ n√≥ ch·ªâ ch·∫°y 1 l·∫ßn duy nh·∫•t, r·∫•t kh√≥ b·ªã ph√°t hi·ªán
        run: echo "count=$(node discover_pages.js)" >> $GITHUB_OUTPUT

  # --- GIAI ƒêO·∫†N 2: TRI·ªÇN KHAI "B·∫¶Y S√ìI B·ªÄN B·ªà" ---
  collect:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Tri·ªÉn khai m·ªôt "b·∫ßy s√≥i" g·ªìm 10 "c√¥ng nh√¢n"
        # 10 c√¥ng nh√¢n s·∫Ω chia nhau to√†n b·ªô s·ªë trang
        worker: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10] 
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4
      - name: 'Set up Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - name: 'Setup Chrome browser for Wolf'
        uses: browser-actions/setup-chrome@latest
      - name: 'Install all project dependencies'
        run: npm install
      
      - name: 'Run Persistent Wolf worker'
        env:
          # Cung c·∫•p "ch√¨a kh√≥a" ƒë·ªÉ "b·ªô ƒë√†m" ho·∫°t ƒë·ªông
          PROXY_API_ENDPOINT: ${{ secrets.PROXY_API_ENDPOINT }}
          PROXY_API_KEY: ${{ secrets.PROXY_API_KEY }}
        run: |
          # T√≠nh to√°n kho·∫£ng trang cho m·ªói "con s√≥i"
          TOTAL_PAGES=${{ needs.discover.outputs.totalPages }}
          TOTAL_WORKERS=10 # Ph·∫£i kh·ªõp v·ªõi s·ªë l∆∞·ª£ng worker trong matrix
          
          # C√¥ng th·ª©c chia vi·ªác: (t·ªïng s·ªë trang + t·ªïng s·ªë worker - 1) / t·ªïng s·ªë worker
          PAGES_PER_WORKER=$(( (TOTAL_PAGES + TOTAL_WORKERS - 1) / TOTAL_WORKERS ))
          
          WORKER_INDEX=${{ matrix.worker }}
          START_PAGE=$(( (WORKER_INDEX - 1) * PAGES_PER_WORKER + 1 ))
          END_PAGE=$(( WORKER_INDEX * PAGES_PER_WORKER ))
          
          # ƒê·∫£m b·∫£o "con s√≥i" cu·ªëi c√πng kh√¥ng ch·∫°y qu√° t·ªïng s·ªë trang
          if (( START_PAGE <= TOTAL_PAGES )); then
            if (( END_PAGE > TOTAL_PAGES )); then
              END_PAGE=$TOTAL_PAGES
            fi
            # "B·∫£n ch·ªâ th·ªã" cho scraper.js
            node scraper.js "ke-toan" $START_PAGE $END_PAGE $WORKER_INDEX
          else
            echo "Worker ${{ matrix.worker }} kh√¥ng c·∫ßn ch·∫°y."
          fi
      
      - name: 'Upload worker artifact'
        uses: actions/upload-artifact@v4
        with:
          name: raw-results-worker-${{ matrix.worker }}
          path: results_worker_${{ matrix.worker }}.csv
          if-no-files-found: ignore

  # --- GIAI ƒêO·∫†N 3: T·ªîNG H·ª¢P V√Ä L∆ØU TR·ªÆ ---
  combine-and-commit:
    needs: collect
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4
      - name: 'Set up Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: 'Download all worker artifacts'
        uses: actions/download-artifact@v4
        with:
          path: ./raw-results
      - name: 'Run combination script'
        id: combine
        run: node combine_results.js
      
      - name: 'Commit results to repository'
        if: steps.combine.outputs.jobs_count > 0
        run: |
          git config --global user.name 'GitHub Actions Scraper'
          git config --global user.email 'actions@github.com'
          git add ${{ steps.combine.outputs.final_filename }}
          git commit -m "üìä D·ªØ li·ªáu TopCV: Th√™m ${{ steps.combine.outputs.jobs_count }} tin m·ªõi v√†o ${{ steps.combine.outputs.final_filename }}"
          git push
