--- QUY TRÌNH TỰ ĐỘNG HÓA CUỐI CÙNG - PHIÊN BẢN "SÁCH HƯỚNG DẪN" ---
Cập nhật: Tin tưởng vào .puppeteerrc.js để tự động cài đặt trình duyệt.
name: 'TopCV Daily Scraper'

on:
schedule:
- cron: '0 0 * * *' # Nửa đêm giờ UTC (7h sáng giờ VN)
workflow_dispatch:

jobs:

--- GIAI ĐOẠN 1: BỔ NHIỆM "TỔNG QUẢN" ---
get-proxy-quartermaster:
runs-on: ubuntu-latest
outputs:
proxy_host: ${{ steps.proxy_info.outputs.proxy_host }}
proxy_port: ${{ steps.proxy_info.outputs.proxy_port }}
steps:
- name: 'Checkout repository'
uses: actions/checkout@v4
- name: 'Set up Node.js'
uses: actions/setup-node@v4
with:
node-version: '18'
- name: 'Download previous proxy state'
uses: actions/download-artifact@v4
with:
name: proxy-state-artifact
path: .
continue-on-error: true
- name: 'Install dependencies for Quartermaster'
run: npm install axios
- name: 'Run Quartermaster to get a valid proxy'
id: proxy_info
env:
PROXY_API_ENDPOINT: ${{ secrets.PROXY_API_ENDPOINT }}
PROXY_API_KEY: ${{ secrets.PROXY_API_KEY }}
run: node get_proxy.js
- name: 'Persist proxy state'
uses: actions/upload-artifact@v4
with:
name: proxy-state-artifact
path: proxy_state.json

--- GIAI ĐOẠN 2: "TRINH SÁT NẰM VÙNG" ---
discover:
needs: get-proxy-quartermaster
runs-on: ubuntu-latest
outputs:
totalPages: ${{ steps.get_pages.outputs.count }}
steps:
- name: 'Checkout repository'
uses: actions/checkout@v4
- name: 'Set up Node.js'
uses: actions/setup-node@v4
with:
node-version: '18'
- name: 'Install dependencies for scout'
# npm install sẽ tự động đọc .puppeteerrc.js và tải trình duyệt
run: npm install puppeteer puppeteer-extra puppeteer-extra-plugin-stealth cheerio
- name: 'Run scout script to get total pages'
id: get_pages
env:
PROXY_HOST: ${{ needs.get-proxy-quartermaster.outputs.proxy_host }}
PROXY_PORT: needs.get−proxy−quartermaster.outputs.proxy_portrun:echo"count=(node discover_pages.js)" >> $GITHUB_OUTPUT

--- GIAI ĐOẠN 3: KHAI THÁC SONG SONG ---
collect:
needs: [discover, get-proxy-quartermaster]
runs-on: ubuntu-latest
strategy:
fail-fast: false
matrix:
worker: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]
steps:
- name: 'Checkout repository'
uses: actions/checkout@v4
- name: 'Set up Node.js'
uses: actions/setup-node@v4
with:
node-version: '18'
cache: 'npm'
- name: 'Install all project dependencies'
# npm install sẽ tự động đọc .puppeteerrc.js và tải trình duyệt
run: npm install

  - name: 'Run collection worker'
    run: |
      PAGES_PER_WORKER=10
      TOTAL_PAGES=${{ needs.discover.outputs.totalPages }}
      PROXY_HOST=${{ needs.get-proxy-quartermaster.outputs.proxy_host }}
      PROXY_PORT=${{ needs.get-proxy-quartermaster.outputs.proxy_port }}
      WORKER_INDEX=${{ matrix.worker }}
      
      START_PAGE=$(( (WORKER_INDEX - 1) * PAGES_PER_WORKER + 1 ))
      END_PAGE=$(( WORKER_INDEX * PAGES_PER_WORKER ))
      
      if (( END_PAGE > TOTAL_PAGES )); then
        END_PAGE=$TOTAL_PAGES
      fi
      
      if (( START_PAGE <= TOTAL_PAGES )); then
        node collector.js "ke-toan" $START_PAGE $END_PAGE $WORKER_INDEX $PROXY_HOST $PROXY_PORT
      else
        echo "Worker ${{ matrix.worker }} không cần chạy."
      fi
  
  - name: 'Upload worker artifact'
    uses: actions/upload-artifact@v4
    with:
      name: raw-results-${{ matrix.worker }}
      path: results_worker_${{ matrix.worker }}.csv
      if-no-files-found: ignore

--- GIAI ĐOẠN 4: TỔNG HỢP VÀ LƯU TRỮ ---
combine-and-commit:
needs: collect
runs-on: ubuntu-latest
steps:
- name: 'Checkout repository'
uses: actions/checkout@v4
- name: 'Set up Node.js'
uses: actions/setup-node@v4
with:
node-version: '18'
- name: 'Download all worker artifacts'
uses: actions/download-artifact@v4
with:
path: ./raw-results
- name: 'Run combination script'
id: combine
run: node combine_results.js

  - name: 'Commit results to repository'
    if: steps.combine.outputs.jobs_count > 0
    run: |
      git config --global user.name 'GitHub Actions Scraper'
      git config --global user.email 'actions@github.com'
      git
